{{/* 系列页模板
  使用该模板要求：
  layout : series
*/}}

{{ define "main" }}
  <header>
    <h1>{{ .Title }}</h1>
    {{ with .Description }}<div class="description">{{ markdownify . }}</div>{{ end }}
  </header>

  <!-- 得到所有系列文章 -->
  {{ $seriesPages := where site.RegularPages ".Params.seriesInfo" "!=" nil }}
  <!-- 根据id分组 -->
  {{ $seriesGroups := dict }}
  {{ $pages := slice }}
  {{ range $seriesPages }}
    {{ $id := .Params.seriesInfo.id }}
    {{ if not (isset $seriesGroups $id) }}
      {{ $seriesGroups = merge $seriesGroups (dict $id (slice .)) }}
    {{ else }}
      {{ $seriesGroups = merge $seriesGroups (dict $id ((index $seriesGroups $id) | append .)) }}
    {{ end }}
  {{ end }}
  <!-- 按照序号排序,获取每个key的第一项 -->
  {{ range $k,$v := $seriesGroups }}
    {{ $nv := sort $v ".Params.seriesInfo.order" }}
    {{ $pages = $pages | append (index $nv 0) }}
  {{ end }}
  <!-- 对文章进行权重/时间排序 -->
  {{ $pages = $pages | partial "pageSort" }}

  <!-- 渲染页面，该页面不支持分页只有自己写 -->
  {{ range $pages }}
    <article class="postEntry {{ cond (eq $.Kind "term") "tagEntry" "" }}">
      <!-- 封面 -->
      {{ partial "common/cover.html" (dict "page" . "inList" true) }}
      <!-- 标题 -->
      <h2 class="title">{{ .Title }}{{ if .Draft }}<sup><span class="draft"> [draft]</span></sup>{{ end }}</h2>
      <!-- 摘要 -->
      {{ if not (.Param "hideSummary") }}
        <div class="content">
          <!-- 移除摘要中的代码行数 -->
          {{ $newSummary := replaceRE "\\d+ " "" .Summary}}
          <!-- 裁剪摘要，有时有异常 -->
          {{/* if gt (len $newSummary) 100 }}{{ $newSummary = slicestr $newSummary 0 100 }}{{ end */}}
          <p>{{ $newSummary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
        </div>
      {{ end }}
      <!-- 元信息 -->
      {{ if not (.Param "hideMeta") }}
        <div class="meta">{{ partial "common/pageMeta.html" . }}</div>
      {{ end }}
      <a class="link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
    </article>
  {{ end }}


  <!-- 设置 css 引用 -->
  {{ .Store.Add "css" (slice "list")}}
{{ end }}
